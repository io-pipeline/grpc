syntax = "proto3";

package io.pipeline.parsed.data.database.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "module/parser/tika/tika_base_metadata.proto";

option java_multiple_files = true;
option java_package = "io.pipeline.parsed.data.database.v1";
option java_outer_classname = "DatabaseMetadataProto";

/**
 * Comprehensive Database metadata as extracted by Tika from database files.
 * Based on Tika's Database interface and actual database parser implementations
 * (JackcessParser, SAS7BDATParser, SQLite3Parser, AbstractDBParser).
 * This is a 1:1 mapping to all fields that Tika can extract from database files.
 * 
 * Supports various database formats: Microsoft Access (.mdb/.accdb), SAS (.sas7bdat),
 * SQLite (.sqlite/.db), and other JDBC-accessible databases.
 */
message DatabaseMetadata {
  // === Core Database Properties (from Database interface) ===
  repeated string table_names = 1;                    // Database.TABLE_NAME (all table names)
  optional int32 total_row_count = 2;                 // Database.ROW_COUNT (total across all tables)
  optional int32 total_column_count = 3;              // Database.COLUMN_COUNT (total across all tables)
  repeated string column_names = 4;                   // Database.COLUMN_NAME (all column names)
  
  // === Core Document Properties (from TikaCoreProperties) ===
  optional string title = 5;                          // TikaCoreProperties.TITLE (database name)
  optional string creator = 6;                        // TikaCoreProperties.CREATOR
  optional string description = 7;                    // TikaCoreProperties.DESCRIPTION
  optional string subject = 8;                        // TikaCoreProperties.SUBJECT
  optional string language = 9;                       // TikaCoreProperties.LANGUAGE
  optional string format = 10;                        // TikaCoreProperties.FORMAT
  optional string identifier = 11;                    // TikaCoreProperties.IDENTIFIER
  optional string comments = 12;                      // TikaCoreProperties.COMMENTS
  optional google.protobuf.Timestamp created = 13;    // TikaCoreProperties.CREATED
  optional google.protobuf.Timestamp modified = 14;   // TikaCoreProperties.MODIFIED
  optional string creator_tool = 15;                  // TikaCoreProperties.CREATOR_TOOL
  
  // === Database Security and Access ===
  optional string password = 16;                      // JackcessParser.MDB_PW (database password)
  optional bool password_protected = 17;              // Whether database requires password
  optional string access_level = 18;                  // Database access permissions
  optional string encryption_type = 19;               // Type of database encryption
  
  // === Database Technical Properties ===
  optional string database_version = 20;              // Database format version
  optional string database_type = 21;                 // Type of database (Access, SQLite, SAS, etc.)
  optional string server_type = 22;                   // OfficeOpenXMLExtended.APPLICATION (server type)
  optional string application_version = 23;           // OfficeOpenXMLExtended.APP_VERSION (app version)
  optional string content_encoding = 24;              // HttpHeaders.CONTENT_ENCODING (character encoding)
  
  // === Architecture and System Properties ===
  optional string architecture_bits = 25;             // MachineMetadata.ARCHITECTURE_BITS (32/64 bit)
  optional string endianness = 26;                    // MachineMetadata.ENDIAN (little/big endian)
  optional string compression_method = 27;            // Database compression method
  optional string page_size = 28;                     // Database page size
  optional int32 page_count = 29;                     // PagedText.N_PAGES (number of pages)
  
  // === Table-Level Statistics ===
  repeated TableInfo tables = 30;                     // Detailed information per table
  optional int32 table_count = 31;                    // Total number of tables
  optional int32 view_count = 32;                     // Number of database views
  optional int32 index_count = 33;                    // Number of database indexes
  optional int32 query_count = 34;                    // Number of stored queries
  
  // === SAS-Specific Properties (from SAS7BDATParser) ===
  optional string sas_release = 35;                   // SAS software release version
  optional string sas_server_type = 36;               // SAS server type
  optional string sas_dataset_name = 37;              // SAS dataset name
  optional string sas_dataset_label = 38;             // SAS dataset label
  optional google.protobuf.Timestamp sas_date_created = 39;  // SAS dataset creation date
  optional google.protobuf.Timestamp sas_date_modified = 40; // SAS dataset modification date
  
  // === Access-Specific Properties (from JackcessParser) ===
  repeated DatabaseProperty mdb_properties = 41;      // MDB_PROPERTY_PREFIX properties
  repeated DatabaseProperty user_defined_properties = 42; // MDB_USER_PROP_PREFIX properties
  optional string mdb_title = 43;                     // TITLE_PROP_KEY
  optional string mdb_author = 44;                    // AUTHOR_PROP_KEY  
  optional string mdb_company = 45;                   // COMPANY_PROP_KEY
  
  // === Content and Resource Properties ===
  optional string content_type = 46;                  // Metadata.CONTENT_TYPE
  optional string content_length = 47;                // Metadata.CONTENT_LENGTH
  optional string resource_name = 48;                 // TikaCoreProperties.RESOURCE_NAME_KEY
  optional string original_resource_name = 49;        // TikaCoreProperties.ORIGINAL_RESOURCE_NAME
  
  // === Database Schema Information ===
  repeated ColumnInfo columns = 50;                   // Detailed column information
  repeated IndexInfo indexes = 51;                    // Database index information
  repeated RelationshipInfo relationships = 52;       // Table relationships/foreign keys
  
  // === Performance and Storage Metrics ===
  optional int64 database_size_bytes = 53;            // Total database file size
  optional int64 data_size_bytes = 54;                // Size of actual data
  optional int64 index_size_bytes = 55;               // Size of indexes
  optional double compression_ratio = 56;             // Compression ratio if applicable
  
  // === Catch-all for unknown/unmapped fields ===
  google.protobuf.Struct additional_metadata = 200;
  
  /**
   * Base Tika fields common to all document types
   */
  io.pipeline.parsed.data.tika.base.v1.TikaBaseFields base_fields = 201;
}

/**
 * Detailed information about a database table
 */
message TableInfo {
  optional string name = 1;                           // Table name
  optional string label = 2;                          // Table label/description
  optional int32 row_count = 3;                       // Number of rows in table
  optional int32 column_count = 4;                    // Number of columns in table
  optional string table_type = 5;                     // Type of table (TABLE, VIEW, etc.)
  optional google.protobuf.Timestamp created = 6;     // Table creation date
  optional google.protobuf.Timestamp modified = 7;    // Table last modified date
  optional int64 size_bytes = 8;                      // Table size in bytes
  repeated string column_names = 9;                   // Names of columns in this table
}

/**
 * Database property key-value pair (for Access MDB properties)
 */
message DatabaseProperty {
  optional string name = 1;                           // Property name
  optional string value = 2;                          // Property value
  optional string type = 3;                           // Property data type
}

/**
 * Detailed information about a database column
 */
message ColumnInfo {
  optional string name = 1;                           // Column name
  optional string label = 2;                          // Column label/description
  optional string table_name = 3;                     // Table this column belongs to
  optional string data_type = 4;                      // Column data type
  optional int32 max_length = 5;                      // Maximum length for text columns
  optional bool nullable = 6;                         // Whether column allows NULL values
  optional bool primary_key = 7;                      // Whether column is primary key
  optional bool auto_increment = 8;                   // Whether column auto-increments
  optional string default_value = 9;                  // Default value for column
  optional string format = 10;                        // Display format for column
}

/**
 * Database index information
 */
message IndexInfo {
  optional string name = 1;                           // Index name
  optional string table_name = 2;                     // Table this index belongs to
  repeated string column_names = 3;                   // Columns included in index
  optional bool unique = 4;                           // Whether index enforces uniqueness
  optional bool primary = 5;                          // Whether this is the primary key index
  optional string index_type = 6;                     // Type of index (BTREE, HASH, etc.)
}

/**
 * Database relationship/foreign key information
 */
message RelationshipInfo {
  optional string name = 1;                           // Relationship name
  optional string from_table = 2;                     // Source table
  optional string to_table = 3;                       // Target table
  repeated string from_columns = 4;                   // Source columns
  repeated string to_columns = 5;                     // Target columns
  optional string relationship_type = 6;              // Type of relationship (ONE_TO_ONE, ONE_TO_MANY, etc.)
  optional string on_delete = 7;                      // Action on delete (CASCADE, RESTRICT, etc.)
  optional string on_update = 8;                      // Action on update (CASCADE, RESTRICT, etc.)
}
