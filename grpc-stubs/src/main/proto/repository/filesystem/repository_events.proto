syntax = "proto3";

package io.pipeline.repository.filesystem;

option java_package = "io.pipeline.repository.filesystem";
option java_outer_classname = "RepositoryEventsV2";
option java_multiple_files = true;

import "google/protobuf/timestamp.proto";

// Minimal source context for audit trail
message SourceContext {
  string component = 1;          // REQUIRED: "repository-service", "connector-xyz"
  string operation = 2;          // REQUIRED: "create", "update", "delete"
  string request_id = 3;         // REQUIRED: For tracing (deterministic UUID)
  
  // Optional context when applicable:
  string user_id = 4;           // If user-initiated
  string connector_id = 5;      // If connector-initiated
  string session_id = 6;        // For grouping related operations
}

// Lean repository event - state changes only
message RepositoryEvent {
  // Deterministic: hash(document_id + operation + timestamp_millis)
  string event_id = 1;
  
  google.protobuf.Timestamp timestamp = 2;
  string document_id = 3;        // Client-provided stable ID
  string account_id = 4;          // From Drive entity
  
  SourceContext source = 5;       // Who/what/where initiated this
  
  // The actual state change
  oneof operation {
    Created created = 10;
    Updated updated = 11;
    Deleted deleted = 12;
  }
  
  // Minimal metadata for created documents
  message Created {
    string s3_key = 1;           // Full S3 key: connectors/{connector_id}/{document_id}.pb
    int64 size = 2;              // File size in bytes
    string content_hash = 3;     // SHA-256 for deduplication
    string s3_version_id = 4;    // S3 version for this creation
  }
  
  // Minimal metadata for updates
  message Updated {
    string s3_key = 1;           // Full S3 key (may have changed if connector changed)
    int64 size = 2;              // New size
    string content_hash = 3;     // New SHA-256 hash
    string s3_version_id = 4;    // New S3 version
    string previous_version_id = 5; // What we replaced
  }
  
  // Minimal reason for deletion
  message Deleted {
    string reason = 1;           // Why it was deleted
    bool purged = 2;             // If true, S3 object was also deleted
  }
}

// Separate analytics events (not for Kafka state stream)
// These would go to metrics/logging systems instead
message AnalyticsEvent {
  string event_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  
  oneof metric {
    AccessMetric access = 10;
    PerformanceMetric performance = 11;
  }
  
  message AccessMetric {
    string document_id = 1;
    string user_id = 2;
    string access_type = 3;     // READ, LIST, etc.
    int64 bytes_read = 4;
    bool cache_hit = 5;
  }
  
  message PerformanceMetric {
    string operation = 1;
    int64 duration_ms = 2;
    int64 bytes_processed = 3;
  }
}